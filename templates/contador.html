{% extends "base.html" %}
{% block title %}Contador Assíncrono{% endblock %}
{% block content %}
  <h2>Contador Assíncrono (via Async View)</h2>
  <p>Ao clicar em iniciar, fazemos chamadas ao endpoint <code>/api/tick/</code> que usa <code>asyncio.sleep(1)</code> (não bloqueante) e devolve um JSON. O contador avança quando a promessa resolve.</p>

  <div>
    <label for="total">Segundos:</label>
    <input id="total" type="number" value="{{ segundos }}" min="1" max="60">
    <button id="start">Iniciar</button>
    <button id="stop" disabled>Parar</button>
  </div>

  <h3>Tempo: <span id="elapsed">0</span>s</h3>

  <script>
    const btnStart = document.getElementById('start');
    const btnStop = document.getElementById('stop');
    const elapsedEl = document.getElementById('elapsed');
    const totalEl = document.getElementById('total');
    let running = false;

    async function tick() {
      const r = await fetch('/api/tick/');
      if (!r.ok) throw new Error('Falha no tick');
      return r.json();
    }

    btnStart.addEventListener('click', async () => {
      if (running) return;
      running = true;
      btnStart.disabled = true;
      btnStop.disabled = false;

      elapsedEl.textContent = '0';
      const total = parseInt(totalEl.value || '10', 10);
      for (let i = 1; i <= total && running; i++) {
        await tick(); // espera 1s no servidor, de forma assíncrona
        elapsedEl.textContent = String(i);
      }
      running = false;
      btnStart.disabled = false;
      btnStop.disabled = true;
    });

    btnStop.addEventListener('click', () => {
      running = false;
      btnStart.disabled = false;
      btnStop.disabled = true;
    });
  </script>
{% endblock %}
